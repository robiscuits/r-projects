---
title: "An Introduction to Epidemiology and COVID-19"
date: "4/1/2020"
output: html_document
fontsize: 12pt
geometry: margin=0.75in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, cache = TRUE)
library(tidyverse)
library(lubridate) ## functions to work with dates
library(viridis)
library(deSolve)
```

## Background

Health data scientist Tim Churches who works at a hospital in Sydney, Australia,
has a blog where he is sharing information about epidemiology and R. The post I saw is at this web site.

\url{https://www.r-bloggers.com/covid-19-epidemiology-with-r/}

However, this post does not have enough R code to reproduce his analysis.

He has longer, more detailed posts here.

\url{https://timchurches.github.io/blog/}

Today, we will follow the first part of analysis in his part 1,
but applied to US data.

\url{https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1/}

### SIR Model

The analysis is based on the simple SIR compartment model.

- S stands for *susceptible*
- I stands for *infected*
- R stands for *recovered*

The model has parameters $\beta$ and $\gamma$.

- $\beta$ is the rate of moving from S to I.
- $\gamma$ is the rate of moving from I to R.

### Reproducibility Number

The ratio $\beta/\gamma$ is an estimate of $R_0$,
which is defined to be the *reproducibility number*,
which is the expected number of people that each infected person will infect,
assuming everyone has the same chance of encountering everyone else.
This number is **not a rate**, as it does not include a time term.
$R_0$ cannot be changed by behavior such as social distancing behaviors
including adherence to stay-at-home orders.

### Effective Reproducibility Number

The value $R_e$, the effective reproducibility number,
does take into account changes in behavior.
After social distancing measures,
we would expect $R_e$ to lower.
In theory, if $R_e$ drops below 1,
the pandemic will eventually die out.

#### Data

There are biases that will effect the accuracy of the model.

- Most of the data we can get is based on **date of reporting**.
- From an epidemiological point of view, it would be more helpful to have dates for each report of the **date when symptoms began**.
- Especially early in an epidemic in a new region, it is important to distinguish between infections which are *imported* and those that are *local transmissions*.
- At later stages, almost all cases will be local transmissions, and mislabeling a few new imports is unimportant.
- I don't know how important it will be to label imports at this stage of the pandemic in the US.

## Data

#### Get the US COVID-19 Data

Here we will compare the estimates of $R_0$ and $R_e$ for two states,
New York and California.
There are many COVID-19 cases in both states,
but California was earlier to institute strict stay-at-home policies
and people in New York City in particular
tend to interact with each other walking on the streets and using public transportation.

```{r us-covid-19}
us_url = "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"
us_covid19 = read_csv(us_url) %>% 
  rename(cumulative_cases = cases) %>% 
  mutate(new_cases = c(0,diff(cumulative_cases)))

## New York
ny = us_covid19 %>% 
  filter(state == "New York")

## California
ca = us_covid19 %>% 
  filter(state == "California")

## Wisconsin
wi =  us_covid19 %>% 
  filter(state == "Wisconsin")
```

## Fit SIR Model

The following code is copied verbatim from Tim Churches blog post.
It uses crappy programming methods that involve using global variable names
inside of functions,
but I am giving up trying to recode it and make it work for the moment.
I want a function that can take in the data and repeat the analysis for different states.
Maybe by Friday....

```{r SIR-model}
SIR <- function(time, state, parameters) {
    par <- as.list(c(state, parameters))
    with(par, {
        dS <- -beta * I * S/N
        dI <- beta * I * S/N - gamma * I
        dR <- gamma * I
        list(c(dS, dI, dR))
    })
}

RSS <- function(parameters) {
    names(parameters) <- c("beta", "gamma")
    out <- ode(y = init, times = Day, func = SIR, parms = parameters)
    fit <- out[, 3]
    sum((Infected - fit)^2)
}
```

#### New York

```{r new-york}
## New York state population
N = 19.54 * 10^6
Infected = ny %>% 
  pull(cumulative_cases)
Day = seq_along(Infected)
init = c(S = N - Infected[1], I = Infected[1], R = 0)
opt_ny = optim(c(0.5, 0.5), RSS, method = "L-BFGS-B",
                lower = c(0, 0), upper = c(1, 1))
names(opt_ny$par) = c("beta","gamma")
opt_ny$par
```

I do not trust NY results because the estimated parameter $\beta$ is at the limit.

#### California

```{r}
## California state population
N = 39.56 * 10^6
Infected = ca %>% 
  pull(cumulative_cases)
Day = seq_along(Infected)
init = c(S = N - Infected[1], I = Infected[1], R = 0)
opt_ca = optim(c(0.5, 0.5), RSS, method = "L-BFGS-B",
                lower = c(0, 0), upper = c(1, 1))
names(opt_ca$par) = c("beta","gamma")
bg_ca = opt_ca$par
bg_ca
R_0 = bg_ca[1]/bg_ca[2]
R_0
```

#### Wisconsin

```{r}
## Wisconsin state population
N = 5.814 * 10^6
Infected = wi %>% 
  pull(cumulative_cases)
Day = seq_along(Infected)
init = c(S = N - Infected[1], I = Infected[1], R = 0)
opt_wi = optim(c(0.5, 0.5), RSS, method = "L-BFGS-B",
                lower = c(0, 0), upper = c(1, 1))
names(opt_wi$par) = c("beta","gamma")
bg_wi = opt_wi$par
bg_wi
R_0 = bg_wi[1]/bg_wi[2]
R_0
```


